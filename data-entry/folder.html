<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.1/xlsx.full.min.js"></script>
    <link href="style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">

    <style>
        /* Add this new CSS for the navigation bar */
          .action-navbar {
            background-color: #d5d5d596;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.229),inset 0 0 10px rgba(0, 0, 0, 0.218);
        }
        
        .action-navbar .btn-group {
            display: flex;
            gap: 10px;
        }

        .filter-type {
    margin-bottom: 8px;
}
.filter-input-between {
    display: none;
}
.multi-select-filter {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px;
    margin-top: 5px;
}
.multi-select-item {
    padding: 3px 5px;
}
.multi-select-item input {
    margin-right: 5px;
}
        .sort-icon {
            font-size: 0.8em;
            margin-left: 5px;
        }
        .table-btn-ed {
            background-color: #ffc107;
            color: #000;
            margin-right: 5px;
        }
        .table-btn-dn {
            background-color: #dc3545;
            color: #fff;
        }
        .wave {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 1000% 1000% 0 0;
            position: fixed;
            width: 200%;
            height: 12em;
            animation: wave 10s -3s linear infinite;
            transform: translate3d(0, 0, 0);
            opacity: 0.8;
            bottom: 0;
            left: 0;
            z-index: -1;
        }
        .wave:nth-of-type(2) {
            bottom: -1.25em;
            animation: wave 18s linear reverse infinite;
            opacity: 0.8;
        }
        .wave:nth-of-type(3) {
            bottom: -2.5em;
            animation: wave 20s -1s reverse infinite;
            opacity: 0.9;
        }
        @keyframes wave {
            2% { transform: translateX(1); }
            25% { transform: translateX(-25%); }
            50% { transform: translateX(-50%); }
            75% { transform: translateX(-25%); }
            100% { transform: translateX(1); }
        }
        
        /* Filter sidebar styles */
        .filter-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1050;
            padding: 20px;
            overflow-y: auto;
        }
        .filter-sidebar.active {
            right: 0;
        }
        .filter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040;
            display: none;
        }
        .filter-overlay.active {
            display: block;
        }
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .filter-group {
            margin-bottom: 15px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filter-suggestions {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            margin-top: 5px;
            display: none;
        }
        .filter-suggestion-item {
            padding: 5px;
            cursor: pointer;
        }
        .filter-suggestion-item:hover {
            background-color: #f0f0f0;
        } 

.form-check-input:checked {
    background-color: red;
}

.form-check-input {
    background-color: rgb(205, 255, 205);
}

        #filterIndicator {
    font-size: 0.9rem;
    margin-left: 10px;
    color: #6c757d;
    display: inline-block;
    vertical-align: middle;
    background-color: #6c757d3b;
    padding: 8px;
    border-radius: 10px;
    border: 1px solid grey;
}

#filterIndicator i {
    margin-right: 5px;
}

.sort-icon{
    font-size: 16px;
}

.summaries-container {
    max-height: 300px;
    overflow-y: auto;
}

.column-sum {
    padding: 5px;
    background-color: #f8f9fa;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.178);
}

.grand-total {
    padding-top: 5px;
    font-size: 1.1em;
    color: #0d6efd;
}
#rowCount{
    padding: 5px;
    background-color: #dddddd40;
    color: #333333;
    font-size: 20px;
    border-radius: 5px;

}
    </style>
</head>
<body>
    <div>
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>

           <!-- Add this navigation bar at the top -->
    <div class="container-fluid mt-2">
        <div class="action-navbar">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="displayAddRowForm()">
                    <i class="fas fa-plus"></i> Add Data
                </button>
                <button class="btn btn-secondary" onclick="displayAddColumnForm()">
                    <i class="fas fa-columns"></i> Add Column
                </button>
                <button class="btn btn-dark" onclick="displayUpdateFilteredDataForm()">
                    <i class="fas fa-sync-alt"></i> Update Data
                </button>
                <button class="btn btn-success" id="downloadExcelBtn">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button class="btn btn-info" id="importExcelBtn">
                    <i class="fas fa-file-import"></i> Import
                </button>
                <input type="file" id="fileInput" style="display: none;" accept=".xlsx, .xls">
                <button class="btn btn-warning" id="displaySumBtn">
                    <i class="fas fa-calculator"></i> Sum
                </button>
                <button class="btn btn-danger" id="deleteAllBtn">
                    <i class="fas fa-trash"></i> Delete Data
                </button>
            </div>
            <div class="ms-auto">
                <button class="btn btn-info" onclick="openFilterSidebar()">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </div>

        <div id="folderData" class="card">
            <div class="card-header">
                <h4 class="text-capitalize"><span id="headerFolderName"></span> Data
                <span id="filterIndicator" class="text-muted mb-0" style="display: none;">
                    <i class="fas fa-filter"></i> Filter Applied

                    <span class="btn btn-secondary" onclick="resetFilters()">Reset Filters</span>
                </span>
                
            </h4>
            </div>
            <div class="card-body" id="formContainer">
                <!-- Search Input and Row Counter -->
                <div id="searchAndCounterContainer">
                    <span id="rowCount" class="mb-3">Showing 0 Data</span><br>
                    <span id="columnSum" class="mb-3" style="display: none;"></span>
                </div>
                <!-- Table will be inserted here dynamically -->
            </div>
        </div>
        </div>

        <!-- Modal for Adding Row -->
        <div class="modal fade" id="addRowModal" tabindex="-1" aria-labelledby="addRowModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addRowModalLabel">Add Row</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="modalFormContainer">
                        <!-- Dynamic Row Input Form will be injected here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-success" onclick="submitRowForm()">Add</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal for Adding Column -->
<div class="modal fade" id="addColumnModal" tabindex="-1" aria-labelledby="addColumnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addColumnModalLabel">Add Column</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addColumnForm">
                    <div class="mb-3">
                        <label for="newColumnName" class="form-label">Column Name</label>
                        <input type="text" class="form-control" id="newColumnName" required>
                    </div>
                    <div class="mb-3">
                        <label for="columnPosition" class="form-label">Position</label>
                        <select class="form-select" id="columnPosition" required>
                            <option value="first">First Column</option>
                            <option value="last" selected>Last Column</option>
                            <option value="before">Before Column</option>
                            <option value="after">After Column</option>
                        </select>
                    </div>
                    <div class="mb-3" id="columnReferenceContainer" style="display: none;">
                        <label for="referenceColumn" class="form-label">Reference Column</label>
                        <select class="form-select" id="referenceColumn">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="defaultValue" class="form-label">Default Value (for existing rows)</label>
                        <input type="text" class="form-control" id="defaultValue" value="">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addNewColumn()">Add Column</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Updating Filtered Data -->
<div class="modal fade" id="updateFilteredModal" tabindex="-1" aria-labelledby="updateFilteredModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateFilteredModalLabel">Update Filtered Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateFilteredForm">
                    <div class="mb-3">
                        <label for="updateColumnSelect" class="form-label">Column to Update</label>
                        <select class="form-select" id="updateColumnSelect" required>
                            <!-- Columns will be populated dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="updateValue" class="form-label">New Value</label>
                        <input type="text" class="form-control" id="updateValue" required>
                    </div>
                    <div class="alert alert-info">
                        This will update <span id="affectedRowsCount">0</span> filtered rows.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateFilteredData()">Update Data</button>
            </div>
        </div>
    </div>
</div>
    </div>

    <!-- Filter Sidebar -->
    <div class="filter-overlay" id="filterOverlay"></div>
    <div class="filter-sidebar" id="filterSidebar">
        <div class="filter-header">
            <h5>Filter Data</h5>
            <button type="button" class="btn-close" onclick="closeFilterSidebar()"></button>
        </div>
        <div id="filterControls">
            <!-- Filter controls will be added here dynamically -->
        </div>
        <div class="d-grid gap-2 mt-3">
            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
        </div>
    </div>

    <script>
const urlParams = new URLSearchParams(window.location.search);
const folderName = urlParams.get('folder');
let folderData = JSON.parse(localStorage.getItem(folderName)) || null;
document.getElementById('headerFolderName').textContent = folderName;

// Load the last selected column index from localStorage
window.lastSumColumnIndex = localStorage.getItem(`${folderName}_sumColumnIndex`);
if (window.lastSumColumnIndex !== null) {
    window.lastSumColumnIndex = parseInt(window.lastSumColumnIndex);
}

// Function to display the data as a table
function displayTable(data) {
    localStorage.setItem('tableData', JSON.stringify(data));

    const tableContainer = document.getElementById('formContainer');
    tableContainer.innerHTML = '';

    // Create search and counter container with sum display
    const searchAndCounterContainer = document.createElement('div');
    searchAndCounterContainer.id = "searchAndCounterContainer";
    searchAndCounterContainer.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
        </div>
        <span id="rowCount" class="mb-3">Showing 0 Data</span><br>
        <span id="columnSum" class="mb-3" style="display: none;"></span>
    `;
    tableContainer.appendChild(searchAndCounterContainer);

    // Rest of your table creation code...
    const table = document.createElement('table');
    table.className = 'table table-striped table-bordered';
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');

    const headersRow = document.createElement('tr');
    data.columns.forEach((column, index) => {
        const th = document.createElement('th');
        th.innerHTML = `${column} <span class="sort-icon">ðŸ”¼ðŸ”½</span>`;
        th.style.cursor = "pointer";
        th.onclick = () => sortTable(index);
        headersRow.appendChild(th);
    });

    const actionHeader = document.createElement('th');
    actionHeader.textContent = "Actions";
    headersRow.appendChild(actionHeader);

    thead.appendChild(headersRow);
    table.appendChild(thead);

    data.rows.forEach((row, rowIndex) => {
        const rowElement = document.createElement('tr');
        row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            rowElement.appendChild(td);
        });

        const actionTd = document.createElement('td');
        const editButton = document.createElement('button');
        editButton.textContent = 'Edit';
        editButton.classList.add('btn', 'table-btn-ed', 'edit-btn');
        editButton.onclick = () => editRow(rowIndex);

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.classList.add('btn', 'table-btn-dn', 'delete-btn');
        deleteButton.onclick = () => deleteRow(rowIndex);

        actionTd.appendChild(editButton);
        actionTd.appendChild(deleteButton);
        rowElement.appendChild(actionTd);
        tbody.appendChild(rowElement);
    });

    table.appendChild(tbody);
    tableContainer.appendChild(table);

           // Instead, add event listeners in your initialization:
           document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcel);
            
            // Set up Import button
            const importBtn = document.getElementById('importExcelBtn');
            const fileInput = document.getElementById('fileInput');
            
            importBtn.addEventListener('click', function() {
                fileInput.click(); // Trigger file input when Import button is clicked
            });
            
            fileInput.addEventListener('change', handleFileUpload); // Handle file selection
            
            document.getElementById('displaySumBtn').addEventListener('click', displayColumnSum);
            document.getElementById('deleteAllBtn').addEventListener('click', deleteAllData);
        });
    
    // Calculate and display sum if a column was previously selected
    if (window.lastSumColumnIndex !== null && !isNaN(window.lastSumColumnIndex)) {
        calculateAndDisplaySum();
    }
    updateRowCount();
}

// Filter sidebar functions
function openFilterSidebar() {
    document.getElementById('filterSidebar').classList.add('active');
    document.getElementById('filterOverlay').classList.add('active');
    populateFilterControls();
}

function closeFilterSidebar() {
    document.getElementById('filterSidebar').classList.remove('active');
    document.getElementById('filterOverlay').classList.remove('active');
}

// In the populateFilterControls function, we could add filter type selection
function populateFilterControls() {
    const filterControls = document.getElementById('filterControls');
    filterControls.innerHTML = '';
    
    if (!folderData || !folderData.columns || !folderData.rows) return;
    
    // Load saved filters if they exist
    const savedFilters = localStorage.getItem(`${folderName}_filters`);
    const activeFilters = savedFilters ? JSON.parse(savedFilters) : {};
    
    folderData.columns.forEach((column, colIndex) => {
        const filterGroup = document.createElement('div');
        filterGroup.className = 'filter-group';

        // Wrapper to hold label and toggle in a single row
        const labelRow = document.createElement('div');
        labelRow.className = 'd-flex justify-content-between align-items-center mb-2';

        // Label
        const label = document.createElement('label');
        label.className = 'mb-0'; // remove bottom margin
        label.textContent = column;
        labelRow.appendChild(label);

        // IN/NOT IN toggle container
        const toggleContainer = document.createElement('div');
        toggleContainer.className = 'd-flex align-items-center ';

        const savedFilter = activeFilters[colIndex];
        const isNotIn = savedFilter ? savedFilter.notIn : false;

        // Toggle switch
        const toggleDiv = document.createElement('div');
        toggleDiv.className = 'form-check form-switch me-2';
        toggleDiv.innerHTML = `
            <input class="form-check-input not-in-toggle" type="checkbox" 
                id="notInToggle-${colIndex}" data-column-index="${colIndex}"
                ${isNotIn ? 'checked' : ''}>
            <label class="form-check-label" for="notInToggle-${colIndex}"></label>
        `;

        // Toggle label text
        const toggleLabel = document.createElement('span');
        toggleLabel.className = 'small';
        toggleLabel.textContent = isNotIn ? 'NOT IN' : 'IN';
        toggleLabel.style.minWidth = '40px';

        toggleContainer.appendChild(toggleDiv);
        toggleContainer.appendChild(toggleLabel);
        labelRow.appendChild(toggleContainer);

        // Add entire label row to filter group
        filterGroup.appendChild(labelRow);

        // Add event listener for toggle label
        toggleDiv.querySelector('.not-in-toggle').addEventListener('change', function() {
            toggleLabel.textContent = this.checked ? 'NOT IN' : 'IN';
        });

        
        // Rest of your filter controls...
        const filterTypeSelect = document.createElement('select');
        filterTypeSelect.className = 'form-select mb-2 filter-type';
        filterTypeSelect.dataset.columnIndex = colIndex;
        
        // Set the saved filter type if it exists
        const savedType = savedFilter ? savedFilter.type : 'contains';
        
        filterTypeSelect.innerHTML = `
            <option value="contains" ${savedType === 'contains' ? 'selected' : ''}>Contains</option>
            <option value="exact" ${savedType === 'exact' ? 'selected' : ''}>Exact Match</option>
            <option value="startsWith" ${savedType === 'startsWith' ? 'selected' : ''}>Starts With</option>
            <option value="endsWith" ${savedType === 'endsWith' ? 'selected' : ''}>Ends With</option>
            ${isNumericColumn(colIndex) ? `
                <option value="greaterThan" ${savedType === 'greaterThan' ? 'selected' : ''}>Greater Than</option>
                <option value="lessThan" ${savedType === 'lessThan' ? 'selected' : ''}>Less Than</option>
                <option value="between" ${savedType === 'between' ? 'selected' : ''}>Between</option>
            ` : ''}
        `;
        filterGroup.appendChild(filterTypeSelect);
        
        // Rest of your filter controls...
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control filter-input';
        input.dataset.columnIndex = colIndex;
        input.placeholder = `Filter by ${column}`;
        input.value = savedFilter ? savedFilter.value : '';
        input.oninput = function() { showSuggestions(this); };
        filterGroup.appendChild(input);
        
        // Add second input for between filter
        const betweenInput = document.createElement('input');
        betweenInput.type = 'text';
        betweenInput.className = 'form-control filter-input-between mt-2';
        betweenInput.dataset.columnIndex = colIndex;
        betweenInput.placeholder = `And`;
        betweenInput.value = savedFilter && savedFilter.value2 ? savedFilter.value2 : '';
        betweenInput.style.display = savedType === 'between' ? 'block' : 'none';
        filterGroup.appendChild(betweenInput);
        
        // Show/hide between input based on filter type
        filterTypeSelect.addEventListener('change', function() {
            betweenInput.style.display = this.value === 'between' ? 'block' : 'none';
        });
        
        const suggestions = document.createElement('div');
        suggestions.className = 'filter-suggestions';
        suggestions.id = `suggestions-${colIndex}`;
        filterGroup.appendChild(suggestions);
        
        filterControls.appendChild(filterGroup);
    });
}

function isNumericColumn(colIndex) {
    // Check if column contains mostly numeric values
    const numericCount = folderData.rows.filter(row => {
        return !isNaN(parseFloat(row[colIndex])) && isFinite(row[colIndex]);
    }).length;
    
    return numericCount / folderData.rows.length > 0.7; // 70% numeric values
}

// Enhanced applyFilters function with proper numeric comparisons
function applyFilters() {
    const filterInputs = document.querySelectorAll('.filter-input');
    const filterTypeSelects = document.querySelectorAll('.filter-type');
    const betweenInputs = document.querySelectorAll('.filter-input-between');
    const filters = {};
    
    filterTypeSelects.forEach(select => {
        const columnIndex = select.dataset.columnIndex;
        const filterType = select.value;
        const input = document.querySelector(`.filter-input[data-column-index="${columnIndex}"]`);
        const betweenInput = document.querySelector(`.filter-input-between[data-column-index="${columnIndex}"]`);
        const value = input ? input.value.trim() : '';
        
        if (value) {
            filters[columnIndex] = {
                type: filterType,
                value: value,
                value2: betweenInput ? betweenInput.value.trim() : '',
                isNumeric: isNumericColumn(columnIndex)
            };
        }
    });
    
    localStorage.setItem(`${folderName}_filters`, JSON.stringify(filters));
    
    
    const rows = document.querySelectorAll("#folderData table tbody tr");
    
    rows.forEach(row => {
        let shouldShow = true;
        
        for (const [colIndex, filter] of Object.entries(filters)) {
            const cell = row.cells[colIndex];
            if (!cell) continue;
            
            const cellText = cell.textContent.trim();
            let cellValue, filterValue, filterValue2;
            
            if (filter.isNumeric) {
                cellValue = parseFloat(cellText);
                filterValue = parseFloat(filter.value);
                filterValue2 = filter.value2 ? parseFloat(filter.value2) : null;
            } else {
                cellValue = cellText.toLowerCase();
                filterValue = filter.value.toLowerCase();
                filterValue2 = filter.value2 ? filter.value2.toLowerCase() : null;
            }
            
            switch(filter.type) {
                case 'contains':
                    shouldShow = cellText.toLowerCase().includes(filter.value.toLowerCase());
                    break;
                case 'exact':
                    if (filter.isNumeric) {
                        shouldShow = !isNaN(cellValue) && !isNaN(filterValue) && cellValue === filterValue;
                    } else {
                        shouldShow = cellText.toLowerCase() === filter.value.toLowerCase();
                    }
                    break;
                case 'startsWith':
                    shouldShow = cellText.toLowerCase().startsWith(filter.value.toLowerCase());
                    break;
                case 'endsWith':
                    shouldShow = cellText.toLowerCase().endsWith(filter.value.toLowerCase());
                    break;
                case 'greaterThan':
                    shouldShow = !isNaN(cellValue) && !isNaN(filterValue) && cellValue > filterValue;
                    break;
                case 'lessThan':
                    shouldShow = !isNaN(cellValue) && !isNaN(filterValue) && cellValue < filterValue;
                    break;
                case 'between':
                    shouldShow = !isNaN(cellValue) && 
                                 !isNaN(filterValue) && 
                                 !isNaN(filterValue2) && 
                                 cellValue >= filterValue && 
                                 cellValue <= filterValue2;
                    break;
                default:
                    shouldShow = cellText.toLowerCase().includes(filter.value.toLowerCase());
            }
            
            if (!shouldShow) break;
        }
        
        row.style.display = shouldShow ? '' : 'none';
    });
    
    updateRowCount();
    closeFilterSidebar();
}

function showSuggestions(inputElement) {
    const columnIndex = inputElement.dataset.columnIndex;
    const searchTerm = inputElement.value.toLowerCase();
    const suggestionsContainer = document.getElementById(`suggestions-${columnIndex}`);
    
    if (!searchTerm) {
        suggestionsContainer.style.display = 'none';
        return;
    }
    
    // Get unique values from the column that match the search term
    const uniqueValues = new Set();
    folderData.rows.forEach(row => {
        const cellValue = row[columnIndex].toString().toLowerCase();
        if (cellValue.includes(searchTerm)) {
            uniqueValues.add(row[columnIndex]);
        }
    });
    
    if (uniqueValues.size === 0) {
        suggestionsContainer.style.display = 'none';
        return;
    }
    
    suggestionsContainer.innerHTML = '';
    Array.from(uniqueValues).slice(0, 10).forEach(value => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'filter-suggestion-item';
        suggestionItem.textContent = value;
        suggestionItem.onclick = function() {
            inputElement.value = value;
            suggestionsContainer.style.display = 'none';
        };
        suggestionsContainer.appendChild(suggestionItem);
    });
    
    suggestionsContainer.style.display = 'block';
}

// Enhanced applyFilters function with proper numeric comparisons
function applyFilters() {
    const filterTypeSelects = document.querySelectorAll('.filter-type');
    const filters = {};
    const notInToggles = document.querySelectorAll('.not-in-toggle');
    
    filterTypeSelects.forEach(select => {
        const columnIndex = select.dataset.columnIndex;
        const filterType = select.value;
        const input = document.querySelector(`.filter-input[data-column-index="${columnIndex}"]`);
        const betweenInput = document.querySelector(`.filter-input-between[data-column-index="${columnIndex}"]`);
        const value = input ? input.value.trim() : '';
        
        // Get the NOT IN toggle state
        const notInToggle = document.querySelector(`#notInToggle-${columnIndex}`);
        const notIn = notInToggle ? notInToggle.checked : false;
        
        if (value) {
            filters[columnIndex] = {
                type: filterType,
                value: value,
                value2: betweenInput ? betweenInput.value.trim() : '',
                isNumeric: isNumericColumn(columnIndex),
                notIn: notIn
            };
        }
    });
    
    // Save the complete filter state including type and notIn
    localStorage.setItem(`${folderName}_filters`, JSON.stringify(filters));
    updateFilterIndicator();
    
    applySavedFilters(filters);
    closeFilterSidebar();
}

function applySavedFilters(filters) {
    const rows = document.querySelectorAll("#folderData table tbody tr");
    
    rows.forEach(row => {
        let shouldShow = true;
        
        for (const [colIndex, filter] of Object.entries(filters)) {
            const cell = row.cells[colIndex];
            if (!cell) continue;
            
            const cellText = cell.textContent.trim();
            let cellValue, filterValue, filterValue2;
            
            if (filter.isNumeric) {
                cellValue = parseFloat(cellText);
                filterValue = parseFloat(filter.value);
                filterValue2 = filter.value2 ? parseFloat(filter.value2) : null;
                
                if (isNaN(cellValue)) {
                    shouldShow = false;
                    break;
                }
            } else {
                cellValue = cellText.toLowerCase();
                filterValue = filter.value.toLowerCase();
                filterValue2 = filter.value2 ? filter.value2.toLowerCase() : null;
            }
            
            let match;
            switch(filter.type) {
                case 'contains':
                    match = cellText.toLowerCase().includes(filter.value.toLowerCase());
                    break;
                case 'exact':
                    if (filter.isNumeric) {
                        match = cellValue === filterValue;
                    } else {
                        match = cellText.toLowerCase() === filter.value.toLowerCase();
                    }
                    break;
                case 'startsWith':
                    match = cellText.toLowerCase().startsWith(filter.value.toLowerCase());
                    break;
                case 'endsWith':
                    match = cellText.toLowerCase().endsWith(filter.value.toLowerCase());
                    break;
                case 'greaterThan':
                    match = cellValue > filterValue;
                    break;
                case 'lessThan':
                    match = cellValue < filterValue;
                    break;
                case 'between':
                    match = cellValue >= filterValue && cellValue <= filterValue2;
                    break;
                default:
                    match = cellText.toLowerCase().includes(filter.value.toLowerCase());
            }
            
            // Apply NOT IN logic if enabled
            shouldShow = filter.notIn ? !match : match;
            
            if (!shouldShow) break;
        }
        
        row.style.display = shouldShow ? '' : 'none';
    });
    
    updateRowCount();
}


function resetFilters() {
    const filterInputs = document.querySelectorAll('.filter-input');
    filterInputs.forEach(input => {
        input.value = '';
    });
    
    // Clear filters from localStorage
    localStorage.removeItem(`${folderName}_filters`);
    updateFilterIndicator();
    
    // Show all rows
    const rows = document.querySelectorAll("#folderData table tbody tr");
    rows.forEach(row => {
        row.style.display = '';
    });
    
    updateRowCount();
}

function loadSavedFilters() {
    const savedFilters = localStorage.getItem(`${folderName}_filters`);
    if (savedFilters) {
        const filters = JSON.parse(savedFilters);
        
        // Apply filters to the table if it exists
        if (document.querySelector("#folderData table tbody tr")) {
            applySavedFilters(filters);
        }
    }
}

function sortTable(columnIndex) {
    let sortOrder = localStorage.getItem('sortOrder') || 'asc';
    let folderData = JSON.parse(localStorage.getItem(folderName));

    folderData.rows.sort((a, b) => {
        let valA = a[columnIndex].toLowerCase();
        let valB = b[columnIndex].toLowerCase();

        if (!isNaN(valA) && !isNaN(valB)) {
            valA = parseFloat(valA);
            valB = parseFloat(valB);
        }

        return sortOrder === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
    });

    localStorage.setItem('sortOrder', sortOrder === 'asc' ? 'desc' : 'asc');
    localStorage.setItem(folderName, JSON.stringify(folderData));
    displayTable(folderData);
    updateRowCount();
    loadSavedFilters(); // Reapply filters after sorting
}

function downloadExcel() {
    // Get all visible rows (after filtering and searching)
    const visibleRows = document.querySelectorAll("#folderData table tbody tr:not([style*='display: none'])");
    
    if (!visibleRows || visibleRows.length === 0) {
        alert("No data available to download.");
        return;
    }

    // Get the column headers from folderData instead of the DOM
    const headers = folderData.columns;

    // Prepare the data for export
    const wsData = [headers];
    
    visibleRows.forEach(row => {
        const rowData = [];
        const cells = row.querySelectorAll("td");
        
        // Skip the last cell (Actions column)
        for (let i = 0; i < cells.length - 1; i++) {
            rowData.push(cells[i].textContent);
        }
        
        wsData.push(rowData);
    });

    // Create and download the Excel file
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "Filtered Data");
    
    // Generate filename with current date/time
    const dateStr = new Date().toISOString().replace(/[:.]/g, "-").slice(0, 19);
    const filename = `Filtered_Data_${dateStr}.xlsx`;
    
    XLSX.writeFile(wb, filename);
}



function updateRowCount() {
    const visibleRows = document.querySelectorAll("#folderData table tbody tr:not([style*='display: none'])").length;
    document.getElementById('rowCount').textContent = `Showing ${visibleRows} Data`;
    calculateAndDisplaySum();
}

function calculateAndDisplaySum() {
    const sumElement = document.getElementById('columnSum');
    
    // Check if we have data to work with
    if (!folderData || !folderData.rows.length) {
        sumElement.style.display = 'none';
        return;
    }

    // Check for multiple column sums first (new feature)
    const savedColumnIndices = localStorage.getItem(`${folderName}_sumColumnIndices`);
    if (savedColumnIndices) {
        const selectedColumns = JSON.parse(savedColumnIndices);
        calculateMultipleColumnsSum(selectedColumns);
        return;
    }
    
    // Fall back to single column sum (original functionality)
    const savedColumnIndex = localStorage.getItem(`${folderName}_sumColumnIndex`);
    if (savedColumnIndex !== null) {
        const columnIndex = parseInt(savedColumnIndex);
        calculateSingleColumnSum(columnIndex);
        return;
    }
    
    // No sum columns selected
    sumElement.style.display = 'none';
}

function calculateSingleColumnSum(columnIndex) {
    const rows = document.querySelectorAll("#folderData table tbody tr:not([style*='display: none'])");
    let sum = 0;
    let count = 0;
    
    rows.forEach(row => {
        const cell = row.cells[columnIndex];
        if (cell) {
            const value = parseFloat(cell.textContent.replace(/[^\d.-]/g, '')); // Improved number parsing
            if (!isNaN(value)) {
                sum += value;
                count++;
            }
        }
    });

    const sumElement = document.getElementById('columnSum');
    sumElement.style.display = 'block';
    sumElement.innerHTML = `Sum of <strong>${folderData.columns[columnIndex]}</strong>: ${sum.toFixed(2)} (from ${count} rows)`;
}

function calculateMultipleColumnsSum(columnIndices) {
    const rows = document.querySelectorAll("#folderData table tbody tr:not([style*='display: none'])");
    let sums = {};
    let counts = {};
    
    // Initialize sums and counts for each column
    columnIndices.forEach(index => {
        sums[index] = 0;
        counts[index] = 0;
    });

    // Calculate sums
    rows.forEach(row => {
        columnIndices.forEach(index => {
            const cell = row.cells[index];
            if (cell) {
                const value = parseFloat(cell.textContent.replace(/[^\d.-]/g, '')); // Improved number parsing
                if (!isNaN(value)) {
                    sums[index] += value;
                    counts[index]++;
                }
            }
        });
    });

    // Generate results HTML
    let resultsHTML = '<div class="multi-sum-results">';
    
    // Individual column sums
    columnIndices.forEach(index => {
        resultsHTML += `
            <span class="column-sum">
                <strong>${folderData.columns[index]}</strong>: ${sums[index].toFixed(2)} (from ${counts[index]} rows) |
            </span>
        `;
    });
    
    // Grand total if multiple columns (from ${totalCount} rows)
    if (columnIndices.length > 1) {
        const grandTotal = columnIndices.reduce((total, index) => total + sums[index], 0);
        const totalCount = columnIndices.reduce((total, index) => total + counts[index], 0);
        resultsHTML += `
            <div class="grand-total">
                <strong>Combined Total</strong>: ${grandTotal.toFixed(2)} 
            </div>
        `;
    }
    
    resultsHTML += '</div>';

    // Display results
    const sumElement = document.getElementById('columnSum');
    sumElement.style.display = 'block';
    sumElement.innerHTML = resultsHTML;
}

// Modified displayColumnSum function to save the selected column
function displayColumnSum() {
    if (!folderData || !folderData.rows.length) {
        alert("No data available to calculate sum.");
        return;
    }

    // Create a modal for column selection
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'sumColumnsModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Columns to Sum</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select columns to include in the sum calculation:</p>
                    <div id="columnCheckboxes" class="mb-3">
                        ${folderData.columns.map((col, index) => `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="${index}" id="colCheck${index}">
                                <label class="form-check-label" for="colCheck${index}">
                                    ${col} (Column ${index + 1})
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="calculateSelectedColumnsSum()">Calculate Sum</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const sumModal = new bootstrap.Modal(document.getElementById('sumColumnsModal'));
    sumModal.show();
}

function calculateSelectedColumnsSum() {
    const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
        alert('Please select at least one column to sum.');
        return;
    }

    const selectedColumns = Array.from(checkboxes).map(checkbox => parseInt(checkbox.value));
    const rows = document.querySelectorAll("#folderData table tbody tr:not([style*='display: none'])");
    
    let sums = {};
    let counts = {};
    
    // Initialize sums and counts for each selected column
    selectedColumns.forEach(colIndex => {
        sums[colIndex] = 0;
        counts[colIndex] = 0;
    });

    // Calculate sums for each column
    rows.forEach(row => {
        selectedColumns.forEach(colIndex => {
            const cell = row.cells[colIndex];
            if (cell) {
                const value = parseFloat(cell.textContent);
                if (!isNaN(value)) {
                    sums[colIndex] += value;
                    counts[colIndex]++;
                }
            }
        });
    });

    // Generate the summary display
    let summaryHTML = '<div class="summaries-container">';
    
    selectedColumns.forEach(colIndex => {
        const columnName = folderData.columns[colIndex];
        const sum = sums[colIndex];
        const count = counts[colIndex];
        
        summaryHTML += `
            <div class="column-summary mb-2">
                <strong>${columnName}</strong>: ${sum.toFixed(2)} (from ${count} rows)
            </div>
        `;
    });

    // Calculate grand total if multiple columns selected
    if (selectedColumns.length > 1) {
        const grandTotal = Object.values(sums).reduce((a, b) => a + b, 0);
        const totalCount = Object.values(counts).reduce((a, b) => a + b, 0);
        
        summaryHTML += `
            <div class="grand-total mt-2 pt-2 border-top">
                <strong>Grand Total</strong>: ${grandTotal.toFixed(2)} (from ${totalCount} rows)
            </div>
        `;
    }

    summaryHTML += '</div>';

    // Display the results
    const sumElement = document.getElementById('columnSum');
    sumElement.style.display = 'block';
    sumElement.innerHTML = summaryHTML;

    // Close the modal
    const sumModal = bootstrap.Modal.getInstance(document.getElementById('sumColumnsModal'));
    sumModal.hide();
    document.body.removeChild(document.getElementById('sumColumnsModal'));

    // Save the selected columns for future reference
    window.lastSumColumnIndices = selectedColumns;
    localStorage.setItem(`${folderName}_sumColumnIndices`, JSON.stringify(selectedColumns));
}

function createColumnForm() {
    const form = document.createElement('form');
    form.innerHTML = `
        <div class="mb-3">
            <label for="numColumns" class="form-label">How many columns?</label>
            <input type="number" id="numColumns" class="form-control" min="1" max="10" required>
        </div>
        <button type="button" class="btn btn-primary" onclick="generateColumnNames()">Next</button>
    `;
    document.getElementById('formContainer').appendChild(form);
}

function generateColumnNames() {
    const numColumns = document.getElementById('numColumns').value;
    if (numColumns <= 0) {
        alert('Please enter a valid number of columns');
        return;
    }

    const form = document.createElement('form');
    form.id = 'columnsForm';

    for (let i = 0; i < numColumns; i++) {
        const div = document.createElement('div');
        div.classList.add('mb-3');
        div.innerHTML = `
            <label for="column${i}" class="form-label">Column ${i + 1} Name:</label>
            <input type="text" id="column${i}" class="form-control" required>
        `;
        form.appendChild(div);
    }

    const saveButton = document.createElement('button');
    saveButton.type = 'button';
    saveButton.classList.add('btn', 'btn-primary');
    saveButton.textContent = 'Save Columns';
    saveButton.onclick = saveColumns;

    form.appendChild(saveButton);

    const formContainer = document.getElementById('formContainer');
    formContainer.innerHTML = '';
    formContainer.appendChild(form);
}

function saveColumns() {
    const columns = [];

    const form = document.getElementById('columnsForm');
    const columnInputs = form.querySelectorAll('input[id^="column"]');

    columnInputs.forEach((columnInput, index) => {
        if (columnInput && columnInput.value.trim()) {
            columns.push(columnInput.value.trim());
        } else {
            alert('Please fill in all column names');
            return;
        }
    });

    folderData = { columns: columns, rows: [] };
    localStorage.setItem(folderName, JSON.stringify(folderData));
    window.location.reload();
}

function addAddRowButton() {
    const addRowButton = document.createElement('button');
    addRowButton.textContent = 'Add';
    addRowButton.classList.add('btn', 'btn-primary', 'mt-3', 'me-2');
    addRowButton.onclick = displayAddRowForm;
    document.getElementById('formContainer').appendChild(addRowButton);
}

function displayAddRowForm() {
    const modalFormContainer = document.getElementById('modalFormContainer');
    modalFormContainer.innerHTML = '';

    folderData.columns.forEach((col, index) => {
        const div = document.createElement('div');
        div.classList.add('mb-3');
        div.innerHTML = `
            <label for="row${index}" class="form-label">${col}</label>
            <input type="text" id="row${index}" class="form-control" required>
        `;
        modalFormContainer.appendChild(div);
    });

    const addRowModal = new bootstrap.Modal(document.getElementById('addRowModal'));
    addRowModal.show();
}

function submitRowForm() {
    const row = folderData.columns.map((col, index) => {
        const input = document.getElementById(`row${index}`);
        return input ? input.value.trim() : '';
    });

    if (row.some(cell => !cell)) {
        alert('Please fill in all fields');
        return;
    }

    folderData.rows.push(row);
    localStorage.setItem(folderName, JSON.stringify(folderData));

    const addRowModal = bootstrap.Modal.getInstance(document.getElementById('addRowModal'));
    addRowModal.hide();

    const formContainer = document.getElementById('formContainer');
    formContainer.innerHTML = '';
    
    const searchAndCounterContainer = document.createElement('div');
    searchAndCounterContainer.id = "searchAndCounterContainer";
    searchAndCounterContainer.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-info" onclick="openFilterSidebar()">
                <i class="fas fa-filter"></i> Filter
            </button>
        </div>
        <span id="rowCount" class="mb-3">Showing 0 Data</span><br>
        <span id="columnSum" class="mb-3" style="display: none;"></span>
    `;
    formContainer.appendChild(searchAndCounterContainer);

    displayTable(folderData);
    updateRowCount();
}

function editRow(rowIndex) {
    const row = folderData.rows[rowIndex];
    const form = document.createElement('form');
    form.innerHTML = `
        <h5>Edit Row</h5>
        ${folderData.columns.map((col, index) => `
            <div class="mb-3">
                <label for="editRow${index}" class="form-label">${col}</label>
                <input type="text" id="editRow${index}" class="form-control" value="${row[index]}" required>
            </div>
        `).join('')}
        <button type="button" class="btn btn-primary" onclick="saveEditedRow(${rowIndex})">Save Changes</button>
    `;
    const formContainer = document.getElementById('formContainer');
    formContainer.innerHTML = '';
    formContainer.appendChild(form);
}

function saveEditedRow(rowIndex) {
    const editedRow = folderData.columns.map((col, index) => {
        const input = document.getElementById(`editRow${index}`);
        return input ? input.value.trim() : '';
    });

    folderData.rows[rowIndex] = editedRow;
    localStorage.setItem(folderName, JSON.stringify(folderData));

    document.getElementById('formContainer').innerHTML = '';
    displayTable(folderData);
    updateRowCount();
    loadSavedFilters(); // Reapply filters after editing
}

function deleteRow(rowIndex) {
    if (confirm('Are you sure you want to delete this row?')) {
        folderData.rows.splice(rowIndex, 1);
        localStorage.setItem(folderName, JSON.stringify(folderData));

        document.getElementById('formContainer').innerHTML = '';
        displayTable(folderData);
        updateRowCount();
        loadSavedFilters(); // Reapply filters after deletion
    }
}

function deleteAllData() {
    if (confirm('Are you sure you want to delete all data for this folder?')) {
        localStorage.removeItem(folderName);
        localStorage.removeItem(`${folderName}_filters`);
        localStorage.removeItem(`${folderName}_sumColumnIndex`);
        folderData = null;
        document.getElementById('formContainer').innerHTML = '';
        alert('All data has been deleted!');
        window.location.reload();
    }
}

function deleteAllData() {
    // Check if there are any active filters
    const savedFilters = localStorage.getItem(`${folderName}_filters`);
    const hasFilters = savedFilters && Object.keys(JSON.parse(savedFilters)).length > 0;

    let confirmMessage = 'Are you sure you want to delete all data for this folder?';
    
    if (hasFilters) {
        confirmMessage = 'You have active filters applied. Do you want to:\n\n' +
                        '1. Delete ALL data (including filtered data)\n' +
                        '2. Delete only the currently VISIBLE (filtered) data\n' +
                        '3. Cancel';
        
        const userChoice = prompt(confirmMessage, '3');
        
        if (userChoice === null || userChoice === '3') {
            return; // User canceled
        }
        
        if (userChoice === '1') {
            // Delete all data
            if (confirm('This will delete ALL data, including filtered data. Are you sure?')) {
                localStorage.removeItem(folderName);
                localStorage.removeItem(`${folderName}_filters`);
                localStorage.removeItem(`${folderName}_sumColumnIndex`);
                folderData = null;
                document.getElementById('formContainer').innerHTML = '';
                alert('All data has been deleted!');
                window.location.reload();
            }
        } else if (userChoice === '2') {
            // Delete only visible (filtered) data
            deleteFilteredData();
        }
    } else {
        // No filters - proceed with normal delete confirmation
        if (confirm(confirmMessage)) {
            localStorage.removeItem(folderName);
            localStorage.removeItem(`${folderName}_filters`);
            localStorage.removeItem(`${folderName}_sumColumnIndex`);
            folderData = null;
            document.getElementById('formContainer').innerHTML = '';
            alert('All data has been deleted!');
            window.location.reload();
        }
    }
}

function deleteFilteredData() {
    // Get all visible rows (after filtering)
    const visibleRowIndices = [];
    const rows = document.querySelectorAll("#folderData table tbody tr");
    
    rows.forEach((row, index) => {
        if (row.style.display !== 'none') {
            visibleRowIndices.push(index);
        }
    });
    
    if (visibleRowIndices.length === 0) {
        alert('No visible rows to delete!');
        return;
    }
    
    // Sort indices in descending order for safe deletion
    visibleRowIndices.sort((a, b) => b - a);
    
    // Delete the visible rows from the data
    visibleRowIndices.forEach(index => {
        folderData.rows.splice(index, 1);
    });
    
    // Save the updated data
    localStorage.setItem(folderName, JSON.stringify(folderData));
    
    // Refresh the display
    document.getElementById('formContainer').innerHTML = '';
    displayTable(folderData);
    updateRowCount();
    alert(`Deleted ${visibleRowIndices.length} visible rows!`);
}

function addImportExcelButton() {
    const importButton = document.createElement('button');
    importButton.textContent = 'Import Excel';
    importButton.classList.add('btn', 'btn-info', 'me-2', 'mt-3');
    importButton.onclick = () => document.getElementById('fileInput').click();

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'fileInput';
    fileInput.style.display = 'none';
    fileInput.accept = '.xlsx, .xls';
    fileInput.onchange = handleFileUpload;

    document.getElementById('formContainer').appendChild(importButton);
    document.getElementById('formContainer').appendChild(fileInput);
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) {
        alert('No file selected');
        return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        if (jsonData.length === 0) {
            alert('The Excel file is empty');
            return;
        }

        // Initialize folderData if it doesn't exist
        if (!folderData) {
            folderData = { 
                columns: jsonData[0], 
                rows: [] 
            };
        }

        // Get existing rows as strings for comparison
        const existingRows = new Set();
        folderData.rows.forEach(row => {
            existingRows.add(row.join('|')); // Using | as delimiter
        });

        // Process new rows
        let newRowsCount = 0;
        for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            const rowString = row.join('|');
            
            // Only add if row doesn't exist
            if (!existingRows.has(rowString)) {
                folderData.rows.push(row);
                newRowsCount++;
            }
        }

        if (newRowsCount === 0) {
            alert('No new data found to import');
        } else {
            alert(`Successfully imported ${newRowsCount} new rows`);
            localStorage.setItem(folderName, JSON.stringify(folderData));
            document.getElementById('formContainer').innerHTML = '';
            displayTable(folderData);
            updateRowCount();
        }

        // Reset file input
        event.target.value = '';
    };

    reader.readAsArrayBuffer(file);
}

function addDownloadExcelButton() {
    const downloadButton = document.createElement('button');
    downloadButton.textContent = 'Excel';
    downloadButton.classList.add('btn', 'btn-success', 'mt-3', 'me-2');
    downloadButton.onclick = downloadExcel;
    document.getElementById('formContainer').appendChild(downloadButton);
}

function addDisplaySumButton() {
    const sumButton = document.createElement('button');
    sumButton.textContent = 'Display Sum';
    sumButton.classList.add('btn', 'btn-warning', 'mt-3', 'me-2');
    sumButton.onclick = displayColumnSum;
    document.getElementById('formContainer').appendChild(sumButton);
}

// Initialize the page
if (folderData) {
    displayTable(folderData);
    updateRowCount();
    loadSavedFilters();
    updateFilterIndicator();
} else {
    createColumnForm();
}

// Close filter sidebar when clicking outside
document.getElementById('filterOverlay').addEventListener('click', closeFilterSidebar);


function displayAddColumnForm() {
    // Populate the reference column dropdown
    const referenceColumnSelect = document.getElementById('referenceColumn');
    referenceColumnSelect.innerHTML = '';
    
    folderData.columns.forEach((column, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = column;
        referenceColumnSelect.appendChild(option);
    });
    
    // Show/hide reference column based on position selection
    const positionSelect = document.getElementById('columnPosition');
    const referenceContainer = document.getElementById('columnReferenceContainer');
    
    positionSelect.addEventListener('change', function() {
        referenceContainer.style.display = (this.value === 'before' || this.value === 'after') ? 'block' : 'none';
    });
    
    // Reset form
    document.getElementById('addColumnForm').reset();
    referenceContainer.style.display = 'none';
    
    // Show modal
    const addColumnModal = new bootstrap.Modal(document.getElementById('addColumnModal'));
    addColumnModal.show();
}

function addNewColumn() {
    const newColumnName = document.getElementById('newColumnName').value.trim();
    if (!newColumnName) {
        alert('Please enter a column name');
        return;
    }
    
    const position = document.getElementById('columnPosition').value;
    const referenceColumnIndex = document.getElementById('referenceColumn').value;
    const defaultValue = document.getElementById('defaultValue').value;
    
    // Determine the insert position
    let insertIndex;
    switch(position) {
        case 'first':
            insertIndex = 0;
            break;
        case 'last':
            insertIndex = folderData.columns.length;
            break;
        case 'before':
            insertIndex = parseInt(referenceColumnIndex);
            break;
        case 'after':
            insertIndex = parseInt(referenceColumnIndex) + 1;
            break;
        default:
            insertIndex = folderData.columns.length;
    }
    
    // Add the new column to columns array
    folderData.columns.splice(insertIndex, 0, newColumnName);
    
    // Add default value to all existing rows
    folderData.rows.forEach(row => {
        row.splice(insertIndex, 0, defaultValue);
    });
    
    // Save and refresh
    localStorage.setItem(folderName, JSON.stringify(folderData));
    
    // Close modal
    const addColumnModal = bootstrap.Modal.getInstance(document.getElementById('addColumnModal'));
    addColumnModal.hide();
    
    // Refresh the table
    document.getElementById('formContainer').innerHTML = '';
    displayTable(folderData);
    updateRowCount();
    loadSavedFilters();
}

function displayUpdateFilteredDataForm() {
    // Get all visible (filtered) rows
    const visibleRows = Array.from(document.querySelectorAll("#folderData table tbody tr")).filter(row => 
        row.style.display !== 'none'
    );
    
    if (visibleRows.length === 0) {
        alert("No filtered rows to update. Please apply filters first.");
        return;
    }
    
    // Populate the column dropdown
    const columnSelect = document.getElementById('updateColumnSelect');
    columnSelect.innerHTML = '';
    
    folderData.columns.forEach((column, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = column;
        columnSelect.appendChild(option);
    });
    
    // Update the count of affected rows
    document.getElementById('affectedRowsCount').textContent = visibleRows.length;
    
    // Reset form
    document.getElementById('updateFilteredForm').reset();
    
    // Show modal
    const updateModal = new bootstrap.Modal(document.getElementById('updateFilteredModal'));
    updateModal.show();
}

function updateFilteredData() {
    const columnIndex = parseInt(document.getElementById('updateColumnSelect').value);
    const newValue = document.getElementById('updateValue').value.trim();
    
    if (isNaN(columnIndex)) {
        alert('Please select a column to update');
        return;
    }
    
    if (newValue === '') {
        alert('Please enter a new value');
        return;
    }
    
    // Get all visible (filtered) row indices from the DOM
    const visibleRows = Array.from(document.querySelectorAll("#folderData table tbody tr")).filter(row => 
        row.style.display !== 'none'
    );
    
    const rowIndices = visibleRows.map(row => 
        Array.from(row.parentNode.children).indexOf(row)
    );
    
    if (rowIndices.length === 0) {
        alert('No rows to update');
        return;
    }
    
    // Update the data in storage
    rowIndices.forEach(rowIndex => {
        if (folderData.rows[rowIndex]) {
            folderData.rows[rowIndex][columnIndex] = newValue;
        }
    });
    
    // Save the updated data
    localStorage.setItem(folderName, JSON.stringify(folderData));
    
    // Close modal
    const updateModal = bootstrap.Modal.getInstance(document.getElementById('updateFilteredModal'));
    updateModal.hide();
    
    // Refresh the table without clearing the container first
    const currentSearch = document.getElementById('searchInput')?.value || '';
    const currentFilters = localStorage.getItem(`${folderName}_filters`);
    displayTable(folderData);
    
    // Reapply search and filters
    if (currentSearch) {
        document.getElementById('searchInput').value = currentSearch;
        searchTable();
    }
    
    if (currentFilters) {
        applySavedFilters(JSON.parse(currentFilters));
    }
    
    alert(`Successfully updated ${rowIndices.length} rows`);
}

function updateFilterIndicator() {
    const filterIndicator = document.getElementById('filterIndicator');
    const savedFilters = localStorage.getItem(`${folderName}_filters`);
    
    if (savedFilters && Object.keys(JSON.parse(savedFilters)).length > 0) {
        filterIndicator.style.display = 'inline-block';
    } else {
        filterIndicator.style.display = 'none';
    }
}
    </script>
</body>
</html>