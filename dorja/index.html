<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dorja | Estimate</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
<link rel="icon" type="image/png" href="img/logo.png">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="style/style.css" rel="stylesheet">
</head>

<body>

<div class="container-fluid mt-2">
<div class="card shadow-lg">
<div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
<h4 class="mb-0">Estimate</h4>

              <div class="dropdown">
              <button class="btn btn-light text-dark py-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <strong>‚ãÆ</strong>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a href="estimate-list.html" class="dropdown-item">
                  üëÅ View Estimate
                    </a>
                </li>
                <li>
                 <a href="services.html" class="dropdown-item">
                 üë®üèª‚Äçüíª Service
                 </a>
                </li>
                <li>
                 <a href="preset.html" class="dropdown-item">
                 üì¶ Packages
                 </a>
                </li>
                  <li class="nav-item mt-3">
                  <a class="bg-danger text-light dropdown-item" onclick="logout()" href="#">
                  „Äê‚èª„Äë Logout
                </a>
              </li>
              </ul>
            </div>

 
 
</div>

<div class="card-body">

<!-- Client -->
<div class="mb-3">
<label class="form-label">Estimate For (Mr/Ms)</label>
<input type="text" id="clientName" class="form-control">
</div>

<!-- Duration + Toggle -->
<div class="row align-items-end">
<div class="col-md-4">
<label class="form-label">Duration</label>
<select id="duration" class="form-select">
<option>‚è≥ Duration: One Week</option>
<option>‚è≥ Duration: One Month</option>
<option>‚è≥ Duration: One Year</option>
<option>‚è≥ Duration: Not Needed</option>
</select>
</div>

<div class="col-md-4">
<div class="form-check form-switch mt-4">
<input class="form-check-input" type="checkbox" id="packageToggle" onchange="toggleMode()">
<label class="form-check-label">Enable Package Mode</label>
</div>
</div>

<div class="col-md-4" id="packageAmountBox" style="display: none;">
<label class="form-label">Package Amount (‚Çπ)</label>
<input type="number" id="packageAmount" class="form-control" oninput="updatePackageTotal()">
</div>
</div>

<hr>

<!-- Add Service Section -->
<div class="row g-1">
<div class="col-md-3">
<label class="form-label">Service Type</label>
<select id="serviceType" class="form-select" onchange="loadServicesByType()">
<option value="">Select Service Type</option>
<option value="Web Services">Web Services</option>
<option value="Media Services">Media Services</option>
<option value="Social Media Services">Social Media Services</option>
<option value="Printing">Printing</option>
</select>
</div>

<div class="col-md-3">
<label class="form-label">Service</label>
<select id="service" class="form-select" disabled onchange="setServiceAmount()">
<option value="">Select Service Type First</option>
</select>
</div>

<div class="col-md-1">
<label class="form-label">Quantity</label>
<input type="number" id="quantity" class="form-control">
</div>

<div class="col-md-2" id="amountBox">
<label class="form-label">Amount (‚Çπ)</label>
<input type="number" id="amount" class="form-control" readonly>
</div>

<div class="col-md-2">
<label class="form-label">Remarks</label>
<input type="text" id="remarks" class="form-control">
</div>

<div class="col-md-1 d-flex align-items-end mt-2">
<button class="btn btn-success w-100" onclick="addService()">‚úö</button>
</div>
</div>

<hr>

<!-- Table -->
<div class="table-responsive">
<table class="table table-bordered mt-3">
<thead class="table-dark">
<tr id="tableHead">
<th>Service</th>
<th>Quantity</th>
<th>Amount</th>
<th>Total</th>
<th>Remarks</th>
<th>Action</th>
</tr>
</thead>
<tbody id="estimateTable"></tbody>
</table>
</div>

<div class="text-end bg-primary text-white p-1">
<h6 class="fw-bold">Grand Total: ‚Çπ <span id="grandTotal">0</span></h6>
</div>
<div class="text-center mt-3">
    <button class="btn btn-primary" onclick="clearURLParams()">
  ‚úö New
 </button>
  <button class="btn btn-success" onclick="saveEstimate()">
    üíæ Save <span class="d-none d-lg-inline">Estimate</span>
  </button>
  <button class="btn btn-success" onclick="generatePDF()">
    üìÑ <span class="d-none d-lg-inline">Generate </span>PDF
  </button>
</div>
</div>
</div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/firebaseconfig.js"></script>

<script>
const database = firebase.database();

let estimateRef = null;
let estimateData = [];
let grandTotal = 0;
let currentUser = null;
let servicesByType = {};

// ================= AUTH CHECK =================
firebase.auth().onAuthStateChanged(function(user){

  if(user){
    currentUser = user;
    
    // Load all services for this user
    loadAllServices();

    const urlParams = new URLSearchParams(window.location.search);
    const estimateId = urlParams.get("id");
    const usePackage = urlParams.get("usePackage");

    if(estimateId){
      // Load Existing Estimate
      estimateRef = database
        .ref("estimate/" + user.uid + "/" + estimateId);
      loadEstimate();
    } else {
      // Create New Estimate
      estimateRef = database
        .ref("estimate/" + user.uid)
        .push();
      
      // Check if we need to load a package
      if(usePackage) {
        // Small delay to ensure services are loaded
        setTimeout(() => {
          loadPackagePreset(usePackage);
        }, 1000);
      }
    }

  } else {
    window.location.href = "login.html";
  }

});

// ================= LOAD ALL SERVICES =================
function loadAllServices(){
  const servicesRef = database.ref("services/" + currentUser.uid);
  
  servicesRef.once("value", function(snapshot){
    if(snapshot.exists()){
      servicesByType = {};
      
      snapshot.forEach(function(child){
        const service = child.val();
        const type = service.type;
        
        if(!servicesByType[type]){
          servicesByType[type] = [];
        }
        
        servicesByType[type].push({
          id: child.key,
          name: service.name,
          amount: service.amount || 0,
          remarks: service.remarks || ""
        });
      });
      
      console.log("Services loaded:", servicesByType);
    }
  }, function(error){
    console.error("Error loading services:", error);
    alert("Error loading services. Please refresh the page.");
  });
}

// ================= LOAD PACKAGE PRESET =================
function loadPackagePreset(packageId) {
    if (!currentUser) {
        console.log("No current user");
        return;
    }
    
    console.log("Loading package:", packageId);
    
    const packageRef = database.ref("packages/" + currentUser.uid + "/" + packageId);
    
    packageRef.once("value", function(snapshot) {
        const pkg = snapshot.val();
        if (!pkg) {
            console.log("Package not found");
            return;
        }
        
        console.log("Package loaded:", pkg);
        
        // Enable package mode
        document.getElementById("packageToggle").checked = true;
        toggleMode(true);
        
        // Set package details
        document.getElementById("packageAmount").value = pkg.amount;
        document.getElementById("duration").value = pkg.duration || "‚è≥ Duration: Not Needed";
        
        // Clear existing data
        grandTotal = parseFloat(pkg.amount) || 0;
        estimateData = [];
        document.getElementById("estimateTable").innerHTML = "";
        
        // Add services from package
        if (pkg.services && pkg.services.length > 0) {
            pkg.services.forEach(service => {
                const table = document.getElementById("estimateTable");
                const row = table.insertRow();
                
                // Format the row based on package mode
                row.innerHTML = `
                    <td>${service.service || ''}</td>
                    <td>${service.quantity || 1}</td>
                    <td>${service.remarks || ''}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteRow(this)">Delete</button></td>`;
                
                // Add to estimateData array
                estimateData.push({
                    service: service.service || '',
                    qty: service.quantity || 1,
                    remarks: service.remarks || '',
                    serviceType: service.serviceType || ''
                });
            });
        }
        
        // Update grand total
        document.getElementById("grandTotal").innerText = grandTotal;
        
        alert("Package loaded successfully!");
    }).catch(function(error) {
        console.error("Error loading package:", error);
        alert("Error loading package: " + error.message);
    });
}

// ================= LOAD SERVICES BY TYPE =================
function loadServicesByType(){
  const serviceType = document.getElementById("serviceType").value;
  const serviceSelect = document.getElementById("service");
  const amountInput = document.getElementById("amount");
  const remarksInput = document.getElementById("remarks");
  
  // Clear and disable service select if no type selected
  if(!serviceType){
    serviceSelect.innerHTML = '<option value="">Select Service Type First</option>';
    serviceSelect.disabled = true;
    amountInput.value = "";
    remarksInput.value = "";
    return;
  }
  
  // Get services for selected type
  const services = servicesByType[serviceType] || [];
  
  // Populate service dropdown
  let options = '<option value="">Select Service</option>';
  services.forEach(service => {
    const remarksText = service.remarks ? ` (${service.remarks.substring(0, 20)}${service.remarks.length > 20 ? '...' : ''})` : '';
    options += `<option value="${service.name}" data-amount="${service.amount}" data-id="${service.id}">${service.name} - ‚Çπ${service.amount}${remarksText}</option>`;
  });
  
  serviceSelect.innerHTML = options;
  serviceSelect.disabled = false;
  amountInput.value = "";
  remarksInput.value = "";
}

// ================= SET SERVICE AMOUNT AND REMARKS =================
function setServiceAmount(){
  const serviceSelect = document.getElementById("service");
  const amountInput = document.getElementById("amount");
  const remarksInput = document.getElementById("remarks");
  const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
  
  if(selectedOption && selectedOption.value){
    const amount = selectedOption.getAttribute("data-amount");
    const serviceId = selectedOption.getAttribute("data-id");
    
    // Set amount
    amountInput.value = amount || 0;
    
    // Find and set remarks from the service data
    const serviceType = document.getElementById("serviceType").value;
    const services = servicesByType[serviceType] || [];
    const selectedService = services.find(s => s.id === serviceId);
    
    if(selectedService && selectedService.remarks) {
      remarksInput.value = selectedService.remarks;
    } else {
      remarksInput.value = "";
    }
  } else {
    amountInput.value = "";
    remarksInput.value = "";
  }
}

// ================= TOGGLE MODE =================
function toggleMode(isLoading = false) {
  const toggle = document.getElementById("packageToggle");
  const packageBox = document.getElementById("packageAmountBox");
  const amountBox = document.getElementById("amountBox");
  const tableHead = document.getElementById("tableHead");
  const tableBody = document.getElementById("estimateTable");

  // Show/hide package amount box
  if (toggle.checked) {
    packageBox.style.display = "block";
    amountBox.style.display = "none";

    tableHead.innerHTML = `
      <th>Service</th>
      <th>Quantity</th>
      <th>Remarks</th>
      <th>Action</th>`;
  } else {
    packageBox.style.display = "none";
    amountBox.style.display = "block";

    tableHead.innerHTML = `
      <th>Service</th>
      <th>Quantity</th>
      <th>Amount</th>
      <th>Total</th>
      <th>Remarks</th>
      <th>Action</th>`;
  }

  // If not loading, clear data
  if (!isLoading) {
    grandTotal = 0;
    estimateData = [];
    tableBody.innerHTML = "";
    document.getElementById("grandTotal").innerText = 0;
    document.getElementById("packageAmount").value = "";
  }
}

// ================= PACKAGE TOTAL =================
function updatePackageTotal() {
  const amount = document.getElementById("packageAmount").value;
  document.getElementById("grandTotal").innerText = amount ? amount : 0;
}

// ================= ADD SERVICE =================
function addService() {
  const toggle = document.getElementById("packageToggle").checked;
  const serviceType = document.getElementById("serviceType").value;
  const service = document.getElementById("service").value;
  const qty = parseInt(document.getElementById("quantity").value);
  const remarks = document.getElementById("remarks").value;

  if (!serviceType || !service || !qty) {
    alert("Please select Service Type, Service and enter Quantity!");
    return;
  }

  const table = document.getElementById("estimateTable");
  const row = table.insertRow();

  if (toggle) {
    row.innerHTML = `
      <td>${service}</td>
      <td>${qty}</td>
      <td>${remarks}</td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteRow(this)">Delete</button></td>`;

    estimateData.push({ service, qty, remarks, serviceType });

  } else {
    const amount = parseFloat(document.getElementById("amount").value);

    if (!amount) {
      alert("Amount is required!");
      return;
    }

    const total = qty * amount;
    grandTotal += total;

    row.innerHTML = `
      <td>${service}</td>
      <td>${qty}</td>
      <td>${amount}</td>
      <td>${total}</td>
      <td>${remarks}</td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteRow(this, ${total})">Delete</button></td>`;

    document.getElementById("grandTotal").innerText = grandTotal;

    estimateData.push({ service, qty, amount, total, remarks, serviceType });
  }

  // Clear fields but keep service type selected
  document.getElementById("quantity").value = "";
  document.getElementById("remarks").value = "";
  document.getElementById("service").value = "";
  document.getElementById("amount").value = "";
}

// ================= DELETE ROW =================
function deleteRow(btn, total = 0) {
  const row = btn.parentElement.parentElement;
  row.remove();

  if (total) {
    grandTotal -= total;
    document.getElementById("grandTotal").innerText = grandTotal;
  }
  
  // Update estimateData array by removing the corresponding item
  // This is a simplified version - you might want to implement a more robust solution
  estimateData = [];
  const table = document.getElementById("estimateTable");
  for (let i = 0; i < table.rows.length; i++) {
    const row = table.rows[i];
    const cells = row.cells;
    if (document.getElementById("packageToggle").checked) {
      estimateData.push({
        service: cells[0].innerText,
        qty: parseInt(cells[1].innerText),
        remarks: cells[2].innerText,
        serviceType: '' // You might want to store this
      });
    } else {
      estimateData.push({
        service: cells[0].innerText,
        qty: parseInt(cells[1].innerText),
        amount: parseFloat(cells[2].innerText),
        total: parseFloat(cells[3].innerText),
        remarks: cells[4].innerText,
        serviceType: '' // You might want to store this
      });
    }
  }
}

// ================= SAVE ESTIMATE =================
function saveEstimate() {

  if (!estimateRef) {
    alert("Estimate not initialized yet!");
    return;
  }

  if (!currentUser) {
    alert("Please login first!");
    window.location.href = "login.html";
    return;
  }

  // ‚ùå Check if at least one service exists
  if (estimateData.length === 0) {
    alert("Please add at least one service before saving!");
    return;
  }

  const rawClientName = document.getElementById("clientName").value.trim();

  if (rawClientName === "") {
    alert("Client name is required!");
    return;
  }

  let formattedClientName = rawClientName.startsWith("üë§")
    ? rawClientName
    : "üë§ " + rawClientName;

  const data = {
    client: formattedClientName,
    duration: document.getElementById("duration").value,
    packageMode: document.getElementById("packageToggle").checked,
    packageAmount: document.getElementById("packageAmount").value || 0,
    grandTotal: document.getElementById("grandTotal").innerText,
    services: estimateData,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  estimateRef.set(data)
    .then(() => {
      alert("Estimate saved successfully!");
    })
    .catch(error => {
      alert("Error saving estimate: " + error.message);
    });
}

// ================= LOAD EXISTING ESTIMATE =================
function loadEstimate(){
  if(!estimateRef) return;

  estimateRef.once("value", function(snapshot){
    const data = snapshot.val();
    if(!data) return;

    document.getElementById("clientName").value = data.client || "";
    document.getElementById("duration").value = data.duration || "Week";
    document.getElementById("packageToggle").checked = data.packageMode || false;
    document.getElementById("packageAmount").value = data.packageAmount || 0;
    document.getElementById("grandTotal").innerText = data.grandTotal || 0;

    // Update UI without clearing data
    toggleMode(true);

    estimateData = data.services || [];
    grandTotal = parseFloat(data.grandTotal) || 0;

    const table = document.getElementById("estimateTable");
    table.innerHTML = "";

    estimateData.forEach(service => {
      const row = table.insertRow();

      if(data.packageMode){
        row.innerHTML = `
          <td>${service.service}</td>
          <td>${service.qty}</td>
          <td>${service.remarks || ""}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteRow(this)">
              Delete
            </button>
          </td>`;
      } else {
        row.innerHTML = `
          <td>${service.service}</td>
          <td>${service.qty}</td>
          <td>${service.amount}</td>
          <td>${service.total}</td>
          <td>${service.remarks || ""}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteRow(this, ${service.total})">
              Delete
            </button>
          </td>`;
      }
    });
  });
}

// ================= GENERATE PDF =================
function generatePDF(){

  if(!estimateRef){
    alert("Estimate not ready yet!");
    return;
  }

  // ‚ùå Check if at least one service added
  if (estimateData.length === 0) {
    alert("Please add at least one service before generating PDF!");
    return;
  }

  // ‚ùå Optional: Check client name
  const clientName = document.getElementById("clientName").value.trim();
  if (clientName === "") {
    alert("Client name is required before generating PDF!");
    return;
  }

  const estimateId = estimateRef.key;
  window.location.href = "estimate-pdf.html?id=" + estimateId;
}

function clearURLParams() {

  // Remove everything after ?
  const cleanURL = window.location.origin + window.location.pathname;

  // Replace URL without reloading first
  window.history.replaceState({}, document.title, cleanURL);

  // Now reload the page
  window.location.reload();

}

// Logout function
function logout() {
  firebase.auth().signOut()
    .then(() => {
      window.location.href = "login.html";
    })
    .catch((error) => {
      alert("Logout failed: " + error.message);
    });
}
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js")
   .then(() => console.log("Service Worker Registered"));
  }
</script>
</body>
</html>